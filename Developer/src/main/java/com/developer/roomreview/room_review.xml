<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.developer.roomreview">


<!-- 특정 스터디룸 후기리스트 전체 출력 START -->
	<resultMap type="RoomReviewVO" id="roomreviewMap" autoMapping = "true">
		<result column="cdate" property="cDate" />
		<result column="star" property="star" />
		<result column="content" property="content" />

		<association property="reservationVO" javaType="ReservationVO" autoMapping="true">
		
			<association property="usersVO" javaType="UsersVO" 	autoMapping="true">
			<result column="nickname" property="nickname" />
			</association>
				
			<association property="studyroomVO" javaType="StudyroomVO" autoMapping="true">
				<result column="sName" property="name" />
				<collection property="roomInfoVO" ofType="RoomInfoVO" autoMapping="true">
				<result column="rifName" property="name" />
				
				</collection>
			</association>
		</association>
	</resultMap>
	<select id="selectAll" resultMap="roomreviewMap">
		SELECT u.nickname, s.name AS sName,	r.name AS rifName, rev.cdate, rev.star, rev.content
		FROM STUDYROOM s, ROOM_INFO r,
		RESERVATION res, ROOM_REVIEW rev, USERS u
		WHERE res.res_seq =
		rev.res_seq
		and u.user_id = res.user_id
		and r.room_seq = res.room_seq
		and s.sr_seq = r.sr_seq
		and s.sr_seq=#{srSeq}
		order by rev.cdate DESC
	</select>
	<!-- 특정 스터디룸 후기리스트 전체 출력 END -->
	<!-- 후기 입력 START -->
	<select id="insertRmRv" resultType="RoomReviewVO">
		INSERT INTO room_review
		VALUES(review_seq.nextval, #{content}, #{star}, SYSDATE,
		#{resSeq})
	</select>
  	<!-- 후기 입력 END -->

<!-- 유저 아이디로 작성한 이용후기 전체목록 출력 START-->
	<resultMap type="RoomReviewVO" id="roomreviewMap22" autoMapping="true" >
		<result column="cdate" property="cDate" />
		<result column="star" property="star" />
		<association property="reservationVO"  javaType="ReservationVO" autoMapping="true">
			<association property="studyroomVO" javaType="StudyroomVO"  autoMapping="true">
				<result column="srName" property="name" />
				<collection property="roomInfoVO" ofType="RoomInfoVO"  autoMapping="true">
					<result column="riName" property="name" />
				</collection>
			</association>
		</association>
	</resultMap>
	<select id="selectMyRmRv" resultMap="roomreviewMap22">
		SELECT s.name AS srName, rif.name AS riName, rr.cdate,
		rr.star
		FROM studyroom s, room_info rif, reservation r, room_review rr
		WHERE s.sr_seq = rif.sr_seq
		AND rif.room_seq = r.room_seq
		AND rr.res_seq = r.res_seq
		AND r.user_id = #{userId}
		ORDER BY RR.CDATE DESC
	</select>
	<!-- 유저 아이디로 작성한 이용후기 전체목록 출력 END-->
<!-- 유저가 작성한 스터디룸 이용후기 상세 START -->
<resultMap type="RoomReviewVO" id="roomreviewMap3" autoMapping="true" >
		<result column="cdate" property="cDate" />
		<result column="star" property="star" />
		<result column="content" property="content" />
		<association property="reservationVO"  javaType="ReservationVO" autoMapping="true">
			<result column="using_date" property="usingDate" />
			<association property="studyroomVO" javaType="StudyroomVO" autoMapping="true">
				<result column="sName" property="name" />
				<collection property="roomInfoVO" ofType="RoomInfoVO"  autoMapping="true">
					<result column="rifName" property="name" />
				</collection>
			</association>
		</association>
	</resultMap>
	<select id="selectMyRmRvDetail" resultMap="roomreviewMap3">
		SELECT s.name AS sName, rif.name AS rifName, r.using_date, rr.cdate,rr.star, rr.content
		FROM studyroom s, room_info rif, reservation r,room_review rr
		WHERE rr.res_seq = r.res_seq
		AND rif.room_seq = r.room_seq
		AND s.sr_seq = rif.sr_seq
		AND r.res_seq = #{res_seq}
	</select>

<!-- 유저가 작성한 스터디룸 이용후기 상세 END -->
<!-- 유저의 미작성 후기 목록 출력 START -->
<resultMap type="ReservationVO" id="roomreviewMap5" autoMapping="true" >

<result column="res_seq" property="resSeq" />
<result column="using_date" property="usingDate" />
<result column="start_time" property="startTime" />
<result column="end_time" property="endTime" />
<association property="studyroomVO" javaType="StudyroomVO"  autoMapping="true">
<id column="sr_seq" property="srSeq"></id>
<result column="sName" property="name" />
<collection property="roomInfoVO" ofType="RoomInfoVO"  autoMapping="true">
					<result column="rifName" property="name" />
				</collection>
</association>

</resultMap>
<select id="selectMyReqRmRv" resultMap="roomreviewMap5">
SELECT r.res_seq , s.name AS sName, rif.name AS rifName, r.using_date, r.start_time, r.end_time
FROM studyroom s, room_info rif, reservation r
WHERE s.sr_seq = rif.sr_seq
AND rif.room_seq = r.room_seq
AND r.user_id = #{userId}
AND TO_DATE(SYSDATE,'yyyy-mm-dd') > TO_DATE(r.using_date, 'yyyy-mm-dd')
MINUS
SELECT r.res_seq, s.name AS sName, rif.name AS rifName, r.using_date, r.start_time, r.end_time
FROM studyroom s, room_info rif, reservation r, room_review rr
WHERE s.sr_seq = rif.sr_seq
AND rif.room_seq = r.room_seq
AND r.res_seq = rr.res_seq
AND r.user_id = #{userId}
</select>
<!-- 유저의 미작성 후기 목록 출력 END -->

</mapper>

<!-- 룸리뷰(예약(유저vo,스터디룸(룸인포))) -->
